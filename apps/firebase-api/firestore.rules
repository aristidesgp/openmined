rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function existingData() {
      return resource.data;
    }

    function incomingData() {
      return request.resource.data;
    }

    function getUserData(user) {
      return get(/databases/$(database)/documents/users/$(user));
    }

    function isAdmin(user) {
      return exists(/databases/$(database)/documents/admins/$(user));
    }

    function isMentor(user) {
      return exists(/databases/$(database)/documents/mentors/$(user));
    }

    function isLoggedIn() {
      return request.auth != null;
    }

    function isSameUser(user) {
      return isLoggedIn() && request.auth.uid == user;
    }

    // TODO: Should write stricter rules here
    match /mentors/{mentor} {
      allow read: if isSameUser(mentor) && isMentor(mentor);
    }

    match /users/{user} {
      // Anyone can read
      allow read;

      // Owner can only write except is_mentor
      allow write: if isSameUser(user)
        && !('is_mentor' in incomingData())

      // *-----*
      // NOTE: If you're writing security rules, MAKE SURE that you fully understand the data model posted in apps/courses/src/DATA-MODEL.md
      // NOTE: All rules that are written must have at least one intentionally passing and one intentionally failing test... the more tests, the better!
      // NOTE: Please use the Firebase emulator for running tests
      // *-----*

      // Only owner can read/write
      match /private/{privateUserVar} {
        allow read, write: if isSameUser(user)
      }

      match /reviews/{review} {
        allow read: if isSameUser(user)
        allow create, update: if isSameUser(user)
      }

      match /courses/{course} {
        function hasStartedCourse(u) {
          return (started_at in u) && !!u.started_at;
        }

        function hasCompletedCourse(u) {
          return hasStartedCourse(u) && !!u.completed_at
        }

        allow read, write: if isSameUser(user)

        // TODO: Cannot complete course if there are incomplete concepts, lessons, or projects
        // TODO: Cannot start or complete lesson without previous lessons being completed
        // TODO: Cannot start or complete concept without previous concepts (and also previous lessons) being completed
        // TODO: Cannot start project without completing previous lessons and all concepts therein
        // TODO: Cannot start or complete project or set the project status without all previous parts being passed OR without one part being failed without any remaining attempts
        // TODO: Student cannot complete a project part or set the project part status, this can only be done by their mentor and requires either the part being passed OR with the part being failed without any remaining attempts
        // TODO: Student cannot write to their own reviews array on the project part
        // TODO: Cannot "restart" or "recomplete" any course, lesson, concept, project, or project part (these values are immutable)

        match /submissions/{submission} {
          allow read, create: if isSameUser(user)
          allow update: if get(existingData().mentor).id == request.auth.uid;
          // TODO: Nobody may edit or delete a submission
          // TODO: Deny read unless it's the same user... see "match /{path=**}/submissions/{submission}" below for where you need to write the rules for mentor read access
        }

        // TODO: Create a reviews subcollection
        // TODO: Students who don't have a role of mentor cannot create records on the reviews subcollection
        // TODO: Students who are also mentors cannot review their own submission
        // TODO: Students who are also mentors cannot create a review for a course they are not allowed to mentor (mentors can only review courses they're allowed to review)
        // TODO: Students who are also mentors cannot edit or delete a review, only read and create
        // TODO: The only students who are allowed to read a review should be a) the mentor who created the review and b) the student whom the review was written for

        match /feedback/{conceptOrLesson} {
          allow read, write: if isSameUser(user)
        }
      }
    }

    // TODO: This is where you'll write the queries for the mentor being able to READ their active submissions
    // TODO: This is different from where you'll allow a mentor to update a submission, or even read an individual submission
    match /{path=**}/submissions/{submission} {
      allow read: if true;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
